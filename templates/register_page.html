{% extends 'base.html' %}

{% block register %}

<form action="{{ url_for('register_page') }}" method="POST" id="mainForm">

    <!-- Шаг 2: общие поля + аллергены -->
    <div id="commonFields">
        <h3 id="formTitle">Регистрация</h3>

        <!-- Общие поля (имя, email и т.д.) -->
        <input type="text" name="name" placeholder="Например: Иван Иванович" class="form-control mb-2" required>
        <input type="email" name="email" placeholder="Например: exemple@gmail.com" class="form-control mb-2" required>
        <input type="password" name="password" placeholder="Например: 123_Abc456" class="form-control mb-2" required>

        <!-- Поле аллергенов -->
        <div id="allergensField" class="mb-3">
            <label class="form-label">Аллергии</label>
            <div id="allergyCheckboxes" class="d-flex flex-wrap gap-2 p-2 border rounded"></div>
            <input type="hidden" name="allergens" id="allergensInput" value="none">
        </div>

        <button type="submit" class="btn btn-success">Зарегистрироваться</button>
        <button type="button" id="backButton" class="btn btn-secondary ms-2">Назад</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const commonFieldsDiv = document.getElementById('commonFields');
    const allergensField = document.getElementById('allergensField');
    const formTitle = document.getElementById('formTitle');
    const allergensContainer = document.getElementById('allergyCheckboxes');
    const allergensInput = document.getElementById('allergensInput');
    const backButton = document.getElementById('backButton');

    // Список аллергенов
    const allergensList = [
        { value: 'eggs', label: 'Яйца' },
        { value: 'milk', label: 'Молоко' },
        { value: 'nuts', label: 'Орехи' },
        { value: 'fish', label: 'Рыба' },
        { value: 'soy', label: 'Соя' },
        { value: 'crustaceans', label: 'Ракообразные' },
        { value: 'wheat', label: 'Пшеница' }
    ];

    // Функция для инициализации кнопок аллергенов
    function initAllergenButtons() {
        if (allergensContainer.children.length > 0) return; // уже инициализировано

        const selected = new Set();

        allergensList.forEach(item => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-secondary btn-sm';
            btn.textContent = item.label;
            btn.dataset.value = item.value;

            btn.addEventListener('click', () => {
                if (selected.has(item.value)) {
                    selected.delete(item.value);
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-secondary');
                } else {
                    selected.add(item.value);
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-primary');
                }
                allergensInput.value = selected.size > 0 ? Array.from(selected).join(',') : 'none';
            });

            allergensContainer.appendChild(btn);
        });
    }

    // ВЫЗЫВАЕМ ФУНКЦИЮ ПРИ ЗАГРУЗКЕ!
    initAllergenButtons();

    // Обработчик кнопки "Назад"
    if (backButton) {
        backButton.addEventListener('click', function() {
            const step1Div = document.getElementById('step1');
            if (step1Div) {
                step1Div.style.display = 'block';
                commonFieldsDiv.style.display = 'none';
                allergensInput.value = 'none';

                // Сбросить все кнопки аллергенов
                document.querySelectorAll('#allergyCheckboxes .btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-secondary');
                });
            }
        });
    }
});
</script>

{% endblock %}